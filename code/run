#!/usr/bin/env bash
set -ex

source $(conda info --base)/etc/profile.d/conda.sh
conda activate correction

export AWS_REQUEST_CHECKSUM_CALCULATION=when_required
export AWS_RESPONSE_CHECKSUM_VALIDATION=when_required

export MALLOC_TRIM_THRESHOLD_=65536

# This is the master script for the capsule. When you click "Reproducible Run", the code in this file will execute.

EXTRA_FLAGS=""

if [ "$8" == "1" ]; then
  EXTRA_FLAGS="--is-binned"
fi

if [ "${11}" == "1" ]; then
  EXTRA_FLAGS="${EXTRA_FLAGS} --skip-flat-field"
fi

if [ "${12}" == "1" ]; then
  EXTRA_FLAGS="${EXTRA_FLAGS} --skip-bkg-sub"
fi

echo "Extra flags: $EXTRA_FLAGS"

TILE_NUM=$(basename "$1")
echo "Processing tile: $TILE_NUM"

python -m exaspim_flatfield_correction.pipeline \
--zarr "$1" \
--output "$2" \
--res "$3" \
--method "$4" \
--flatfield-path "$5" \
--num-workers "$6" \
--mask-dir "$7" \
--n-levels 7 \
--results-dir "/results" \
--save-outputs \
--fitting-config "$9" \
--worker-mode "${10}" \
--overwrite $EXTRA_FLAGS

echo "Done!"
